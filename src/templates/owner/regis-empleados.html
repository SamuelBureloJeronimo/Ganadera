{% extends 'owner/panel.html' %}


{% block title_bar %} 
<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#75FB4C"><path d="M200-246q54-53 125.5-83.5T480-360q83 0 154.5 30.5T760-246v-514H200v514Zm280-194q58 0 99-41t41-99q0-58-41-99t-99-41q-58 0-99 41t-41 99q0 58 41 99t99 41ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm69-80h422q-44-39-99.5-59.5T480-280q-56 0-112.5 20.5T269-200Zm211-320q-25 0-42.5-17.5T420-580q0-25 17.5-42.5T480-640q25 0 42.5 17.5T540-580q0 25-17.5 42.5T480-520Zm0 17Z"/></svg>
REGISTRAR EMPLEADOS
{% endblock %}

{% block cont_dash %}
<form id="regForm" action="{{ url_for('BP_Owner.create_employee') }}" method="POST" style="padding: 2%">
    <div style="margin-bottom: 3vh">
        <label>Datos del empleado</label>
        <hr />
    </div>
    <!-- DATOS IMPORTANTES DE CONETACTO DEL DUEÑO -->
    <div class="sam-form-container">
        <div class="sam-form-field">
            <input type="text" id="rfc" placeholder=" " name="rfc" required />
            <label class="itim-regular">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e8eaed">
                    <path
                        d="M481-781q106 0 200 45.5T838-604q7 9 4.5 16t-8.5 12q-6 5-14 4.5t-14-8.5q-55-78-141.5-119.5T481-741q-97 0-182 41.5T158-580q-6 9-14 10t-14-4q-7-5-8.5-12.5T126-602q62-85 155.5-132T481-781Zm0 94q135 0 232 90t97 223q0 50-35.5 83.5T688-257q-51 0-87.5-33.5T564-374q0-33-24.5-55.5T481-452q-34 0-58.5 22.5T398-374q0 97 57.5 162T604-121q9 3 12 10t1 15q-2 7-8 12t-15 3q-104-26-170-103.5T358-374q0-50 36-84t87-34q51 0 87 34t36 84q0 33 25 55.5t59 22.5q34 0 58-22.5t24-55.5q0-116-85-195t-203-79q-118 0-203 79t-85 194q0 24 4.5 60t21.5 84q3 9-.5 16T208-205q-8 3-15.5-.5T182-217q-15-39-21.5-77.5T154-374q0-133 96.5-223T481-687Zm0-192q64 0 125 15.5T724-819q9 5 10.5 12t-1.5 14q-3 7-10 11t-17-1q-53-27-109.5-41.5T481-839q-58 0-114 13.5T260-783q-8 5-16 2.5T232-791q-4-8-2-14.5t10-11.5q56-30 117-46t124-16Zm0 289q93 0 160 62.5T708-374q0 9-5.5 14.5T688-354q-8 0-14-5.5t-6-14.5q0-75-55.5-125.5T481-550q-76 0-130.5 50.5T296-374q0 81 28 137.5T406-123q6 6 6 14t-6 14q-6 6-14 6t-14-6q-59-62-90.5-126.5T256-374q0-91 66-153.5T481-590Zm-1 196q9 0 14.5 6t5.5 14q0 75 54 123t126 48q6 0 17-1t23-3q9-2 15.5 2.5T744-191q2 8-3 14t-13 8q-18 5-31.5 5.5t-16.5.5q-89 0-154.5-60T460-374q0-8 5.5-14t14.5-6Z" />
                </svg>
                RFC</label>
        </div>

        <div class="sam-form-field">
            <input type="email" id="correo" placeholder=" " name="correo" required />
            <label class="itim-regular">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#000000">
                    <path
                        d="M160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm320-280L160-640v400h640v-400L480-440Zm0-80 320-200H160l320 200ZM160-640v-80 480-400Z" />
                </svg>
                Correo eléctronico</label>
        </div>

        <div class="sam-form-field">
            <input type="number" id="tel" placeholder=" " name="tel" required />
            <label class="itim-regular">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#000000">
                    <path
                        d="M798-120q-125 0-247-54.5T329-329Q229-429 174.5-551T120-798q0-18 12-30t30-12h162q14 0 25 9.5t13 22.5l26 140q2 16-1 27t-11 19l-97 98q20 37 47.5 71.5T387-386q31 31 65 57.5t72 48.5l94-94q9-9 23.5-13.5T670-390l138 28q14 4 23 14.5t9 23.5v162q0 18-12 30t-30 12ZM241-600l66-66-17-94h-89q5 41 14 81t26 79Zm358 358q39 17 79.5 27t81.5 13v-88l-94-19-67 67ZM241-600Zm358 358Z" />
                </svg>
                Teléfono</label>
        </div>
    </div>

    <div class="sam-form-container">
        <div class="sam-form-field">
            <input type="text" id="nombe" placeholder=" " name="nombre" required />
            <label class="itim-regular">Nombre(s)</label>
        </div>
        <div class="sam-form-field">
            <input type="text" id="app" placeholder=" " name="app" required />
            <label class="itim-regular">Apellido paterno</label>
        </div>
        <div class="sam-form-field">
            <input type="text" id="apm" placeholder=" " name="apm" required />
            <label class="itim-regular">Apellido materno</label>
        </div>
        <div class="sam-form-field">
            <input type="date" id="fech_nac" placeholder=" " name="fech_nac" required />
            <label class="itim-regular">Fecha de nacimiento</label>
        </div>
        <div class="sam-form-field">
            <select id="sex" name="sex" required>
                <option value="" selected disabled>Género</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
            </select>
        </div>
        <div class="sam-form-field" id="especial">
            <select id="rol" name="rol" required>
                <option value="" selected disabled>Puesto del empleado</option>
                <option value="1">Administrador</option>
                <option value="2">Contabilidad</option>
                <option value="3">Secretaria</option>
                <option value="4">Capataz</option>
                <option value="5">Jornalero</option>
                <option value="6">Veterinario</option>
            </select>
        </div>
    </div>

    <div style="margin-top: 3vh; margin-bottom: 3vh">
        <label>Dirección</label>
        <hr />
    </div>

    <div class="sam-form-container">
        <div class="sam-form-field">
            <select id="paises" name="paises" required onchange="selectPais()">
                <option value="" disabled selected>Selecciona el pais</option>
            </select>
        </div>
        <div class="sam-form-field">
            <select id="estados" name="estados" required onchange="selectEstado()" disabled="true">
                <option value="" disabled selected>Selecciona el estado</option>
            </select>
        </div>
        <div class="sam-form-field">
            <select id="municipios" name="municipios" required onchange="selectMunicipio()" disabled="true">
                <option value="" disabled selected>Selecciona el municipio</option>
            </select>
        </div>

        <div class="sam-form-field">
            <select id="id_colonia" name="id_colonia" required disabled="true">
                <option value="" disabled selected>Selecciona la colonia</option>
            </select>
        </div>
    </div>

    <div style="margin-top: 3vh">
        <label>Asignar a una finca</label>
        <hr />
    </div>

    <div class="sam-form-container">
        <div class="sam-form-field">
            <select id="finca_id" name="finca_id" required>
                <option value="" selected disabled>Selecciona una finca</option>
            </select>
        </div>
    </div>

    <button class="btn btn-primary" color="primary" type="submit">
        Registrar
    </button>
</form>

<script>
    fetch("/get-paises", { method: "GET" })
        .then((response) => response.json())
        .then((data) => {
            console.log(data);
            // Llenar el select con las opciones de los países
            let selectPais = document.getElementById("paises");
            data.forEach((estado) => {
                let option = document.createElement("option");
                option.value = estado.id;
                option.textContent = estado.nom;
                selectPais.appendChild(option);
            });
        });

        fetch("/get-all-fincas", { 
            method: "GET",
            headers: { "Authorization": "Bearer " + token }
        })
        .then((response) => response.json())
        .then((data) => {
            console.log(data);
            // Llenar el select con las opciones de los países
            let fincas = document.getElementById("finca_id");
            data.forEach((finca) => {
                let option = document.createElement("option");
                option.value = finca.id;
                option.textContent = finca.nombre;
                fincas.appendChild(option);
            });
        });

    // ################ SE CARGAN LOS DATOS DE LOS PAISES ################

    function selectPais() {
        let selectElement = document.getElementById("paises");
        let pais_id = selectElement.value;

        fetch("/get-estados/" + pais_id, {
            method: "GET",
        })
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                // Llenar el select con las opciones de los países
                let selectEst = document.getElementById("estados");
                selectEst.innerHTML =
                    '<option value="" disabled selected>Selecciona el estado</option>';
                data.forEach((estado) => {
                    let option = document.createElement("option");
                    option.value = estado.id;
                    option.textContent = estado.nom;
                    selectEst.appendChild(option);
                });
                selectEst.disabled = false;
            });
    }

    // ################ SE CARGAN LOS DATOS DE LOS ESTADOS ################

    function selectEstado() {
        let selectElement = document.getElementById("estados");
        let estado_id = selectElement.value;

        fetch("/get-municipios/" + estado_id, {
            method: "GET",
        })
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                // Llenar el select con las opciones de los países
                let selectMun = document.getElementById("municipios");
                selectMun.innerHTML =
                    '<option value="" disabled selected>Selecciona el municipio</option>';
                data.forEach((mun) => {
                    let option = document.createElement("option");
                    option.value = mun.id;
                    option.textContent = mun.nom;
                    selectMun.appendChild(option);
                });
                selectMun.disabled = false;
            });
    }

    function selectMunicipio() {
        let selectElement = document.getElementById("municipios");
        let mun_id = selectElement.value;

        fetch("/get-colonias/" + mun_id, {
            method: "GET",
        })
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                // Llenar el select con las opciones de los países
                let selectCol = document.getElementById("id_colonia");
                selectCol.innerHTML =
                    '<option value="" disabled selected>Selecciona la colonia</option>';
                data.forEach((col) => {
                    let option = document.createElement("option");
                    option.value = col.id;
                    option.textContent = col.nom;
                    selectCol.appendChild(option);
                });
                selectCol.disabled = false;
            });
    }

    addSwalAlertCre("regForm", "/create_employee");
    function addSwalAlertCre(id, endpoint, url_redir) {
        document.getElementById(id).addEventListener("submit", function (event) {
            event.preventDefault(); // Evita que la página se recargue

            let formData = new FormData(this);

            fetch(endpoint, {
                method: "POST",
                body: formData,
                headers: {
                    Authorization: "Bearer " + token,
                },
            })
                .then((response) => {
                    if (response.status === 401) {
                        // Si el token ha expirado
                        return response.json().then((data) => {
                            Swal.fire({
                                title: "Sesión expirada",
                                text: data.error,
                                icon: "info",
                                confirmButtonText: "Aceptar",
                            }).then(() => {
                                window.location.href = "/"; // Redirige después del alert
                            });
                        });
                    } else if (response.status === 400) {
                        // Si es 400
                        return response.json().then((data) => {
                            Swal.fire({
                                title: "Un error a ocurrido",
                                text: data.error,
                                icon: "warning",
                                confirmButtonText: "Aceptar",
                            });
                        });
                    } else if (response.status === 200) {
                        // Si es 400
                        return response.json().then((data) => {
                            document.getElementById("regForm").reset();
                            Swal.fire({
                                title: "Nuevo empleado registrado",
                                text: data.msg,
                                icon: "success",
                            });
                        });
                    }
                })
                .then((data) => { });
        });
    }

</script>
{% endblock %}